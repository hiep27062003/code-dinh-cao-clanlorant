<footer class="footer">
    <div class="top-footer">
        <div class="container">
            <div class="row">
                <div class="col-12 col-md-6 col-lg-7 col-xl-6">
                    <form id="mc-form" class="newsletter-form" data-toggle="validator">
                        {{-- Form nh·∫≠p email --}}
                    </form>
                </div>
                <div class="col-12 col-md-6 col-lg-5 col-xl-6">
                    <div class="footer-social">
                        <span>K·∫øt n·ªëi v·ªõi ch√∫ng t√¥i:</span>
                        <ul class="social">
                            <li><a href="https://zalo.me/0868418343" title="Zalo"><img width="32" height="32" title="Zalo" class="lazyload" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" data-src="//bizweb.dktcdn.net/100/112/815/themes/966034/assets/zalo.png?1742954225872"></a></li>
                            <li><a href="https://www.facebook.com/hoanghiep2706/" title="Facebook"><img width="32" height="32" title="Facebook" class="lazyload" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" data-src="//bizweb.dktcdn.net/100/112/815/themes/966034/assets/facebook.png?1742954225872"></a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mid-footer">
        <div class="container">
            <div class="row row-fix">
                <div class="col-6 col-md-6 col-lg-3 col-xl-3 link-list col-footer footer-click col-fix">
                    <h4 class="title-menu title-menu2">Ch√≠nh s√°ch</h4>
                    <ul class="list-menu hidden-mobile">
                        <li><a href="/cam-ket-chat-luong" title="Cam k·∫øt ch·∫•t l∆∞·ª£ng">Cam k·∫øt ch·∫•t l∆∞·ª£ng</a></li>
                        <li><a href="/customer/warranty" title="Cam k·∫øt ch·∫•t l∆∞·ª£ng">B·∫£o h√†nh</a></li>
                        <li><a href="/chinh-sach-bao-mat-thong-tin" title="Ch√≠nh s√°ch b·∫£o m·∫≠t">Ch√≠nh s√°ch b·∫£o m·∫≠t</a></li>
                    </ul>
                </div>
                <div class="col-6 col-md-6 col-lg-3 col-xl-3 link-list col-footer footer-click col-fix">
                    <h4 class="title-menu title-menu2">MUA H√ÄNG</h4>
                    <ul class="list-menu hidden-mobile">
                        <li><a href="/huong-dan" title="H∆∞·ªõng d·∫´n mua h√†ng">H∆∞·ªõng d·∫´n mua h√†ng</a></li>
                        <li><a href="/quy-trinh-mua-hang" title="Quy tr√¨nh mua h√†ng">Quy tr√¨nh mua h√†ng</a></li>
                        <li><a href="/phuong-thuc-thanh-toan" title="Ph∆∞∆°ng th·ª©c thanh to√°n">Ph∆∞∆°ng th·ª©c thanh to√°n</a></li>
                        <li><a href="/chinh-sach-tra-gop" title="Ph∆∞∆°ng th·ª©c tr·∫£ g√≥p">Ph∆∞∆°ng th·ª©c tr·∫£ g√≥p</a></li>
                    </ul>
                </div>
                <div class="col-6 col-md-6 col-lg-3 col-xl-3 link-list col-footer footer-click col-fix">
                    <h4 class="title-menu title-menu2">ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</h4>
                    <ul class="list-menu hidden-mobile">
                        <li><a href="/dieu-khoan-su-dung" title="Di·ªÅu kho·∫£n d·ªãch v·ª•">Di·ªÅu kho·∫£n d·ªãch v·ª•</a></li>
                        <li><a href="/dieu-khoan-html" title="ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a></li>
                        <li><a href="/chinh-sach" title="Cam k·∫øt b·∫£o m·∫≠t">Cam k·∫øt b·∫£o m·∫≠t</a></li>
                        <li><a href="/gioi-thieu" title="Gi·ªõi thi·ªáu">Gi·ªõi thi·ªáu</a></li>
                        <li><a href="/lien-he" title="Li√™n h·ªá">Li√™n h·ªá</a></li>
                    </ul>
                </div>
                <div class="col-6 col-md-6 col-lg-3 col-xl-3 link-list col-footer footer-click col-fix">
                    <h4 class="title-menu title-menu2">Li√™n H·ªá</h4>
                    <ul class="list-menu hidden-mobile">
                        <li><a href="/" title="Mua h√†ng online: 0868">Mua h√†ng: 0868418343</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div id="copyright" class="copyright">
        <div class="container">
            <div class="row">
                <div class="col-12 col-lg-12">
                    <span class="copy-right">B·∫£n quy·ªÅn thu·ªôc v·ªÅ <b>NTShop</b>.</span>
                    <span class="opacity1">Cung c·∫•p b·ªüi <a href="#" rel="noopener" title="Sapo" target="_blank">TH-36</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

<a href="#" class="backtop" title="L√™n ƒë·∫ßu trang">
    <svg style="margin: auto;" aria-hidden="true" focusable="false" data-prefix="far" data-icon="angle-up" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="svg-inline--fa fa-angle-up fa-w-10">
        <path fill="currentColor" d="M168.5 164.2l148 146.8c4.7 4.7 4.7 12.3 0 17l-19.8 19.8c-4.7 4.7-12.3 4.7-17 0L160 229.3 40.3 347.8c-4.7 4.7-12.3 4.7-17 0L3.5 328c-4.7-4.7-4.7-12.3 0-17l148-146.8c4.7-4.7 12.3-4.7 17 0z"></path>
    </svg>
</a>

<div class="fixed-bottom-mobile d-lg-none d-block">
    <ul>
        <li><a href="/"><img width="25" height="25" src="//bizweb.dktcdn.net/100/112/815/themes/966034/assets/icon_fixed_1.png?1742954225872" alt="Trang ch·ªß"><span>Trang ch·ªß</span></a></li>
        <li class="menu-bar"><a href="javascript:void(0)"><img width="25" height="25" src="//bizweb.dktcdn.net/100/112/815/themes/966034/assets/icon_fixed_2.png?1742954225872" alt="Danh m·ª•c"><span>Danh m·ª•c</span></a></li>
        <li><a href="/cart"><img width="25" height="25" src="//bizweb.dktcdn.net/100/112/815/themes/966034/assets/icon_fixed_3.png?1742954225872" alt="Khuy·∫øn m√£i"><span>Gi·ªè h√†ng</span><span class="count count_item_pr">3</span></a></li>
    </ul>
</div>

<div style="visibility:hidden; position: absolute; z-index: -1; bottom: 0; left: 0;">
    <svg xmlns="http://www.w3.org/2000/svg"><symbol id="icon-cart"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="#fff" d="M253.3 35.1c6.1-11.8 1.5-26.3-10.2-32.4s-26.3-1.5-32.4 10.2L117.6 192H32c-17.7 0-32 14.3-32 32s14.3 32 32 32L83.9 463.5C91 492 116.6 512 146 512H430c29.4 0 55-20 62.1-48.5L544 256c17.7 0 32-14.3 32-32s-14.3-32-32-32H458.4L365.3 12.9C359.2 1.2 344.7-3.4 332.9 2.7s-16.3 20.6-10.2 32.4L404.3 192H171.7L253.3 35.1zM192 304v96c0 8.8-7.2 16-16 16s-16-7.2-16-16V304c0-8.8 7.2-16 16-16s16 7.2 16 16zm96-16c8.8 0 16 7.2 16 16v96c0 8.8-7.2 16-16 16s-16-7.2-16-16V304c0-8.8 7.2-16 16-16zm128 16v96c0 8.8-7.2 16-16 16s-16-7.2-16-16V304c0-8.8 7.2-16 16-16s16 7.2 16 16z" /></svg></symbol></svg>
</div>

<div class="addThis_listSharing" style="display: block;">
    <div class="listSharing_action">
        <button type="button" class="addThis_close" data-dismiss="modal">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95 1.414-1.414 4.95 4.95z"/></svg>
        </button>
        
        <ul class="addThis_listing">
            <li class="addThis_item">
                <a class="addThis_item--icon" href="tel:0867023153" title="G·ªçi ngay"><img src="https://img.icons8.com/color/48/000000/phone.png" width="40"><span class="tooltip-text">G·ªçi ngay</span></a>
            </li>
            <li class="addThis_item">
                <a class="addThis_item--icon" href="https://zalo.me/0868418343" target="_blank"><img src="https://img.icons8.com/color/48/000000/zalo.png" width="40"><span class="tooltip-text">Zalo</span></a>
            </li>
            
            <!-- CHAT REALTIME + BOT -->
            <li class="addThis_item">
                <a class="addThis_item--icon" href="javascript:void(0)" onclick="window.toggleChatForm()">
                    <img src="https://img.icons8.com/color/48/000000/chat--v1.png" width="40">
                    <span class="tooltip-text">Chat h·ªó tr·ª£</span>
                </a>
                
                <div id="chatForm" class="chat-box hidden">
                    <div class="chat-header">
                        <strong>üí¨ Chat v·ªõi ch√∫ng t√¥i</strong>
                        <button type="button" onclick="window.toggleChatForm()" style="background:none;border:none;color:white;font-size:18px;">‚úñ</button>
                    </div>
                    
                    <!-- TOGGLE CH·∫æ ƒê·ªò: Bot AI / Admin -->
                    <div class="chat-mode-toggle">
                        <button type="button" id="btnModeBot" class="mode-btn active" onclick="window.switchChatMode('bot')">
                            ü§ñ Bot AI
                        </button>
                        <button type="button" id="btnModeAdmin" class="mode-btn" onclick="window.switchChatMode('admin')">
                            üë§ Admin
                        </button>
                    </div>
                    
                    <div class="chat-body">
                        <div class="messages" id="messages"></div>
                        <form onsubmit="window.handleSendMessage(event)">
                            <input type="file" id="fileInput" class="d-none">
                            <button type="button" class="btn btn-light me-2" onclick="document.getElementById('fileInput').click();" id="btnAttach">
                                üìé
                            </button>
                            <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." required />
                            <button type="submit">G·ª≠i</button>
                        </form>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    <div class="listSharing_overlay"></div>
</div>

<div class="addThis_iconContact">
    <div class="box-item item-contact">
        <div class="svgico">
            <img src="https://img.icons8.com/color/48/000000/messaging-.png" width="30" style="margin: auto;">
        </div>
    </div>
</div>

<style>
    
    .chat-box { position: absolute; left: -405px; bottom: 0; width: 400px; background: #fff; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); z-index: 10000; display: flex; flex-direction: column; font-family: sans-serif; animation: fadeIn 0.3s ease-in-out; }
    .chat-box.hidden { display: none !important; }
    .chat-header { background: linear-gradient(to right, #fecf72, #ef9f00); padding: 10px; color: white; display: flex; justify-content: space-between; align-items: center; border-radius: 12px 12px 0 0; }
    
    /* Toggle Mode */
    .chat-mode-toggle { display: flex; gap: 5px; padding: 8px; background: #f5f5f5; border-bottom: 1px solid #ddd; }
    .mode-btn { flex: 1; padding: 6px; border: none; background: white; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.3s; }
    .mode-btn.active { background: #ef9f00; color: white; font-weight: bold; }
    
    .chat-body { padding: 10px; display: flex; flex-direction: column; height: 350px; }
    .messages { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 6px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px;}
    .chat-body form { display: flex; gap: 5px; padding: 10px 0 0; border-top: 1px solid #eee; }
    .chat-body input[type="text"] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
    .chat-body button[type="submit"] { padding: 8px 15px; background: #ef9f00; border: none; border-radius: 20px; color: white; cursor: pointer; }
    
    /* Tin nh·∫Øn */
    .chat-list { display: flex; align-items: flex-end; width: 100%; }
    .chat-list.right { flex-direction: row-reverse; }
    .user-chat-content { max-width: 75%; padding: 8px 12px; border-radius: 12px; font-size: 14px; position: relative; }
    .chat-list.left .user-chat-content { background: #fff; border: 1px solid #eee; }
    .chat-list.right .user-chat-content { background: #ef9f00; color: white; }
    .chat-avatar img { width: 30px; height: 30px; border-radius: 50%; margin: 0 5px; }
    .meta { font-size: 10px; color: #999; margin-top: 4px; display: block; text-align: right; }
    .chat-list.right .meta { color: #eee; }
    
    /* Badge Bot */
    .bot-badge { display: inline-block; background: #4CAF50; color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
    
    /* Typing indicator */
    .typing-indicator { display: flex; gap: 4px; padding: 8px; }
    .typing-indicator span { width: 8px; height: 8px; background: #999; border-radius: 50%; animation: bounce 1.4s infinite; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-10px); } }
    
    /* Responsive */
    @media (max-width: 768px) {
        .chat-box { left: auto; right: 0; bottom: 80px; width: 300px; }
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>

@vite('resources/js/app.js')

<script type="module">
    // ==========================================
    // 1. CONFIG & SHARED STATE
    // ==========================================
    const AppConfig = {
        userId: @json(Auth::check() ? Auth::user()->id : null),
        csrfToken: document.querySelector('meta[name="csrf-token"]')?.content || '',
        urls: {
            botAsk: '{{ route('guest.chatbot.ask') }}',
            adminSend: '{{ route('chatClient.sendMessage') }}',
            adminLoad: '{{ route('chat.getDataChatClient') }}',
            storage: '{{ Storage::url('') }}'
        }
    };

    const AppState = {
        mode: 'bot', // 'bot' | 'admin'
        botSessionId: null,
        isTyping: false
    };

    // ==========================================
    // 2. UI MANAGER (Qu·∫£n l√Ω giao di·ªán chung)
    // ==========================================
    const ChatUI = {
        dom: {
            form: document.getElementById('chatForm'),
            messages: document.getElementById('messages'),
            input: document.getElementById('chatInput'),
            fileInput: document.getElementById('fileInput'),
            btnAttach: document.getElementById('btnAttach'),
            btnBot: document.getElementById('btnModeBot'),
            btnAdmin: document.getElementById('btnModeAdmin')
        },

        toggle: function() {
            this.dom.form.classList.toggle('hidden');
            if (!this.dom.form.classList.contains('hidden')) {
                // N·∫øu m·ªü form, kh·ªüi t·∫°o d·ª±a theo mode hi·ªán t·∫°i
                if (AppState.mode === 'admin') AdminService.init();
                else BotService.init();
            }
        },

        switchMode: function(mode) {
            AppState.mode = mode;
            
            // Update Tab Active
            this.dom.btnBot.classList.toggle('active', mode === 'bot');
            this.dom.btnAdmin.classList.toggle('active', mode === 'admin');
            
            // ·∫®n/Hi·ªán n√∫t attach file
            this.dom.btnAttach.style.display = (mode === 'bot') ? 'none' : 'block';

            // Clear m√†n h√¨nh & Kh·ªüi t·∫°o service t∆∞∆°ng ·ª©ng
            this.dom.messages.innerHTML = '';
            if (mode === 'bot') BotService.init();
            else AdminService.init();
        },

        renderMessage: function(data) {
            const isMe = data.sender_id === AppConfig.userId || data.sender_id === 'guest';
            const isBot = data.isBot || data.sender_id === 'bot';
            const side = isMe ? 'right' : 'left';
            
            // Avatar logic
            let avatarSrc = 'https://img.icons8.com/color/36/000000/administrator-male.png';
            if (isBot) avatarSrc = 'https://img.icons8.com/color/36/000000/bot.png';
            const avatar = !isMe ? `<div class="chat-avatar"><img src="${avatarSrc}"></div>` : '';

            // Badge & Media
            const badge = isBot ? '<span class="bot-badge">AI</span>' : '';
            let mediaHtml = '';
            if (data.media_path) {
                const src = data.media_path.startsWith('blob:') ? data.media_path : `${AppConfig.urls.storage}${data.media_path}`;
                mediaHtml = `<div class="chat-media"><img src="${src}" style="max-width: 150px; border-radius: 8px; margin-top:5px;"></div>`;
            }

            const time = new Date(data.created_at).toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});

            const html = `
                <div class="chat-list ${side}">
                    ${avatar}
                    <div class="user-chat-content">
                        <p style="margin:0">${data.message || ''} ${badge}</p>
                        ${mediaHtml}
                        <span class="meta">${time}</span>
                    </div>
                </div>
            `;
            
            this.dom.messages.insertAdjacentHTML('beforeend', html);
            this.scrollToBottom();
        },

        renderProductSuggestions: function(suggestions) {
            if (!Array.isArray(suggestions) || suggestions.length === 0) return;
            const html = suggestions.map(s => `
                <div class="chat-list left">
                    <div class="user-chat-content" style="max-width:100%">
                        <a href="${s.url}" target="_blank" style="display:flex;gap:10px;align-items:center;text-decoration:none;color:inherit">
                            <img src="${s.image || ''}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;flex:0 0 64px;">
                            <div style="flex:1">
                                <div style="font-weight:600">${s.name}</div>
                                <div style="color:#ff4444;font-weight:700">${s.price ? new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND'}).format(s.price) : ''}</div>
                            </div>
                        </a>
                    </div>
                </div>
            `).join('');
            this.dom.messages.insertAdjacentHTML('beforeend', html);
            this.scrollToBottom();
        },

        showTyping: function() {
            if (AppState.isTyping) return;
            AppState.isTyping = true;
            const html = `
                <div class="chat-list left typing-box">
                    <div class="chat-avatar"><img src="https://img.icons8.com/color/36/000000/bot.png"></div>
                    <div class="user-chat-content">
                        <div class="typing-indicator"><span></span><span></span><span></span></div>
                    </div>
                </div>`;
            this.dom.messages.insertAdjacentHTML('beforeend', html);
            this.scrollToBottom();
        },

        hideTyping: function() {
            const typing = document.querySelector('.typing-box');
            if (typing) typing.remove();
            AppState.isTyping = false;
        },

        scrollToBottom: function() {
            setTimeout(() => {
                this.dom.messages.scrollTop = this.dom.messages.scrollHeight;
            }, 100);
        }
    };

    // ==========================================
    // 3. BOT SERVICE (X·ª≠ l√Ω Logic AI)
    // ==========================================
    const BotService = {
        init: function() {
            // Tin nh·∫Øn ch√†o m·ª´ng
            ChatUI.renderMessage({
                message: 'Xin ch√†o! Em l√† Bot AI. Anh/ch·ªã c·∫ßn t∆∞ v·∫•n g√¨ ·∫°?',
                sender_id: 'bot',
                created_at: new Date(),
                isBot: true
            });
        },

        handleSend: async function(message) {
            ChatUI.showTyping();
            
            try {
                const response = await axios.post(AppConfig.urls.botAsk, {
                    message: message,
                    session_id: AppState.botSessionId
                });

                ChatUI.hideTyping();

                if (response.data.session_id) {
                    AppState.botSessionId = response.data.session_id;
                }

                ChatUI.renderMessage({
                    message: response.data.reply,
                    sender_id: 'bot',
                    created_at: new Date(),
                    isBot: true
                });
                // N·∫øu backend tr·∫£ v·ªÅ suggestions, hi·ªÉn th·ªã ch√∫ng
                if (Array.isArray(response.data.suggestions) && response.data.suggestions.length) {
                    ChatUI.renderProductSuggestions(response.data.suggestions);
                }

            } catch (error) {
                console.error("Bot Error:", error);
                ChatUI.hideTyping();
                ChatUI.renderMessage({
                    message: 'H·ªá th·ªëng ƒëang b·∫£o tr√¨, vui l√≤ng th·ª≠ l·∫°i sau!',
                    sender_id: 'bot',
                    created_at: new Date(),
                    isBot: true
                });
            }
        }
    };

    // ==========================================
    // 4. ADMIN SERVICE (X·ª≠ l√Ω Logic Chat Admin)
    // ==========================================
    const AdminService = {
        init: function() {
            if (!AppConfig.userId) {
                ChatUI.dom.messages.innerHTML = `
                    <div class="chat-list left">
                        <div class="user-chat-content">
                            <p>Vui l√≤ng <a href="/login" style="color:blue">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ chat v·ªõi Admin!</p>
                        </div>
                    </div>`;
                return;
            }
            this.loadHistory();
            this.listenRealtime();
        },

        loadHistory: function() {
            axios.post(AppConfig.urls.adminLoad)
                .then(res => {
                    if (Array.isArray(res.data.data)) {
                        res.data.data.forEach(msg => ChatUI.renderMessage(msg));
                    }
                })
                .catch(err => console.error("Load History Error:", err));
        },

        handleSend: async function(message, file) {
            if (!AppConfig.userId) {
                alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!");
                window.location.href = "/login";
                return;
            }

            let formData = new FormData();
            formData.append('message', message);
            if (file) formData.append('file', file);

            try {
                await axios.post(AppConfig.urls.adminSend, formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                // Th√†nh c√¥ng - kh√¥ng c·∫ßn l√†m g√¨ v√¨ renderMessage ƒë√£ ch·∫°y ·ªü Main Controller
                // v√† Realtime s·∫Ω lo ph·∫ßn c√≤n l·∫°i n·∫øu c·∫ßn x√°c nh·∫≠n t·ª´ server
            } catch (error) {
                console.error("Admin Send Error:", error);
                alert("L·ªói g·ª≠i tin nh·∫Øn: " + (error.response?.data?.message || "L·ªói k·∫øt n·ªëi"));
            }
        },

        listenRealtime: function() {
            if (AppConfig.userId && window.Echo) {
                Echo.private(`chat.${AppConfig.userId}`)
                    .listen('.MessageSent', (e) => {
                        // Ch·ªâ hi·ªÉn th·ªã n·∫øu ƒëang ·ªü tab Admin v√† ng∆∞·ªùi g·ª≠i kh√¥ng ph·∫£i l√† m√¨nh
                        if (AppState.mode === 'admin' && e.sender_id !== AppConfig.userId) {
                            ChatUI.renderMessage(e);
                        }
                    });
            }
        }
    };

    // ==========================================
    // 5. MAIN CONTROLLER (ƒêi·ªÅu ph·ªëi)
    // ==========================================
    
    // G·∫Øn s·ª± ki·ªán Global cho HTML g·ªçi v√†o
    window.toggleChatForm = () => ChatUI.toggle();
    window.switchChatMode = (mode) => ChatUI.switchMode(mode);

    window.handleSendMessage = function(event) {
        event.preventDefault();
        
        const message = ChatUI.dom.input.value.trim();
        const file = ChatUI.dom.fileInput.files[0];

        if (!message && !file) return;

        // 1. Hi·ªÉn th·ªã tin nh·∫Øn c·ªßa User l√™n m√†n h√¨nh ngay l·∫≠p t·ª©c (Optimistic UI)
        ChatUI.renderMessage({
            message: message,
            sender_id: AppConfig.userId || 'guest',
            created_at: new Date(),
            isBot: false,
            media_path: file ? URL.createObjectURL(file) : null
        });

        // 2. Reset input
        ChatUI.dom.input.value = '';
        ChatUI.dom.fileInput.value = '';

        // 3. ƒêi·ªÅu h∆∞·ªõng logic
        if (AppState.mode === 'bot') {
            BotService.handleSend(message);
        } else {
            AdminService.handleSend(message, file);
        }
        // ... trong h√†m handleSendMessage ...
        if (response.data.session_id) {
            window.botSessionId = response.data.session_id;
        }
    };

    // Sidebar Logic (Gi·ªØ nguy√™n)
    const sidebar = {
        item: document.querySelector('.addThis_iconContact .item-contact'),
        close: document.querySelector('.addThis_listSharing .addThis_close'),
        overlay: document.querySelector('.listSharing_overlay'),
        list: document.querySelector('.addThis_listSharing'),
        toggle: function() {
            if (this.list.classList.contains('active')) {
                this.list.classList.remove('active');
                this.list.style.display = 'none';
            } else {
                this.list.style.display = 'block';
                setTimeout(() => this.list.classList.add('active'), 10);
            }
        }
    };
    if(sidebar.item) sidebar.item.addEventListener('click', () => sidebar.toggle());
    if(sidebar.close) sidebar.close.addEventListener('click', () => sidebar.toggle());
    if(sidebar.overlay) sidebar.overlay.addEventListener('click', () => sidebar.toggle());

</script>